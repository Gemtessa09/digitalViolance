<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Record Video Evidence - ReportSafe</title>
    <link href="/css/style.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="/images/shield-icon.svg" />
    <script src="/js/recorder.js"></script>
    <style>
      .video-container {
        position: relative;
        background: #000;
        border-radius: 1rem;
        overflow: hidden;
        min-height: 400px;
      }

      .recording-indicator {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .timer-display {
        font-family: "Courier New", monospace;
        font-size: 1.5rem;
        font-weight: bold;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
      }

      .recording-controls {
        position: absolute;
        bottom: 2rem;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 1rem;
        z-index: 10;
      }

      .record-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .record-button.start {
        background: #ef4444;
        box-shadow: 0 0 0 8px rgba(239, 68, 68, 0.3);
      }

      .record-button.stop {
        background: #ef4444;
        transform: scale(0.9);
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.5);
      }

      .record-button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
      }

      .video-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .placeholder-video {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: white;
        text-align: center;
        padding: 2rem;
      }

      .permission-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 2rem;
        text-align: center;
        z-index: 20;
      }

      .video-thumbnail {
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .video-thumbnail:hover {
        transform: scale(1.05);
      }

      .video-thumbnail .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #3b82f6;
        width: 0%;
        transition: width 0.3s ease;
      }

      .instruction-card {
        background: #f8fafc;
        border-left: 4px solid #3b82f6;
        border-radius: 0.5rem;
        padding: 1.5rem;
      }

      .warning-card {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
        border-radius: 0.5rem;
        padding: 1.5rem;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 1rem;
        width: 90%;
        max-width: 800px;
        position: relative;
      }

      .modal-close {
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 2rem;
        color: white;
        cursor: pointer;
        z-index: 1001;
        background: rgba(0, 0, 0, 0.5);
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .camera-select {
        background: #1f2937;
        color: white;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        padding: 0.5rem;
      }

      .quality-select {
        background: #1f2937;
        color: white;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        padding: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    <!-- Trust & Privacy Banner -->
    <div class="bg-blue-900 text-white text-center py-2 px-4">
      <p class="text-sm">
        ðŸ”’ <strong>Secure & Anonymous</strong> - Your safety is our priority.
        All videos are encrypted.
      </p>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b sticky top-0 z-50">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center space-x-2">
            <div class="bg-blue-600 p-2 rounded-lg">
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                ></path>
              </svg>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">ReportSafe</h1>
              <p class="text-xs text-gray-500">
                Digital Violence Reporting System
              </p>
            </div>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-6">
            <a
              href="index.html"
              class="text-gray-700 hover:text-blue-600 font-medium transition duration-200"
              >Home</a
            >
            <a
              href="report.html"
              class="text-gray-700 hover:text-blue-600 font-medium transition duration-200"
              >Report Incident</a
            >
            <a
              href="recorder.html"
              class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium transition duration-200 shadow-sm"
            >
              Record Video
            </a>
          </div>

          <!-- Mobile Menu Button -->
          <button id="mobile-menu-button" class="md:hidden text-gray-700">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden py-4 border-t">
          <div class="flex flex-col space-y-4">
            <a href="/" class="text-gray-700 hover:text-blue-600 font-medium"
              >Home</a
            >
            <a
              href="report.html"
              class="text-gray-700 hover:text-blue-600 font-medium"
              >Report Incident</a
            >
            <a
              href="recorder.html"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-center"
            >
              Record Video
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      <div class="max-w-6xl mx-auto">
        <!-- Page Header -->
        <div class="mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Record Video Evidence
          </h1>
          <p class="text-gray-600">
            Record a video statement securely. All recordings are encrypted and
            protected.
          </p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
          <!-- Left Column - Video Recorder -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Camera Preview -->
            <div class="video-container" id="videoContainer">
              <!-- Placeholder before camera access -->
              <div class="placeholder-video" id="placeholderVideo">
                <svg
                  class="w-24 h-24 text-gray-400 mb-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
                <h3 class="text-xl font-bold text-white mb-2">
                  Camera Preview
                </h3>
                <p class="text-gray-300">
                  Click "Allow" when prompted to access your camera
                </p>
              </div>

              <!-- Video Element -->
              <video
                id="previewVideo"
                class="video-preview"
                autoplay
                muted
                playsinline
              ></video>

              <!-- Recording Indicator -->
              <div
                id="recordingIndicator"
                class="hidden absolute top-4 left-4 bg-red-600 text-white px-3 py-1 rounded-full flex items-center"
              >
                <span
                  class="recording-indicator w-2 h-2 bg-white rounded-full mr-2"
                ></span>
                <span class="font-bold">REC</span>
                <span id="timer" class="timer-display ml-2">00:00</span>
              </div>

              <!-- Permission Overlay -->
              <div id="permissionOverlay" class="permission-overlay">
                <svg
                  class="w-16 h-16 text-yellow-400 mb-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m0 0v2m0-2h2m-2 0H9m3-9a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                </svg>
                <h3 class="text-xl font-bold mb-2">Camera Access Required</h3>
                <p class="text-gray-300 mb-4">
                  Please allow camera access to record video evidence.
                </p>
                <button
                  id="requestPermission"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200"
                >
                  Allow Camera Access
                </button>
              </div>

              <!-- Recording Controls -->
              <div class="recording-controls">
                <button
                  id="startRecording"
                  class="record-button start"
                  title="Start Recording"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                </button>
                <button
                  id="stopRecording"
                  class="record-button stop hidden"
                  title="Stop Recording"
                  disabled
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <rect x="8" y="8" width="8" height="8"></rect>
                  </svg>
                </button>
                <button
                  id="pauseRecording"
                  class="record-button bg-yellow-500 hidden"
                  title="Pause Recording"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Camera Controls -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <h3 class="font-bold text-lg mb-4">Camera Settings</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-gray-700 mb-2 font-medium"
                    >Camera</label
                  >
                  <select id="cameraSelect" class="camera-select w-full">
                    <option value="">Select Camera...</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium"
                    >Quality</label
                  >
                  <select id="qualitySelect" class="quality-select w-full">
                    <option value="hd">HD (720p)</option>
                    <option value="fullhd" selected>Full HD (1080p)</option>
                    <option value="4k">4K (If available)</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium"
                    >Orientation</label
                  >
                  <div class="flex space-x-2">
                    <button
                      id="portraitMode"
                      class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg"
                    >
                      Portrait
                    </button>
                    <button
                      id="landscapeMode"
                      class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg"
                    >
                      Landscape
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recorded Videos -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <h3 class="font-bold text-lg mb-4">Recorded Videos</h3>
              <div id="recordedVideos" class="space-y-4">
                <p class="text-gray-500 text-center py-8" id="noVideosMessage">
                  No videos recorded yet. Press the red button to start
                  recording.
                </p>
              </div>
            </div>
          </div>

          <!-- Right Column - Instructions & Info -->
          <div class="space-y-6">
            <!-- Instructions -->
            <div class="instruction-card">
              <h3 class="font-bold text-lg mb-3 flex items-center">
                <svg
                  class="w-5 h-5 text-blue-600 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                How to Record
              </h3>
              <ol class="space-y-3 text-gray-700">
                <li class="flex items-start">
                  <span
                    class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0"
                    >1</span
                  >
                  Allow camera access when prompted
                </li>
                <li class="flex items-start">
                  <span
                    class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0"
                    >2</span
                  >
                  Press the red button to start recording
                </li>
                <li class="flex items-start">
                  <span
                    class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0"
                    >3</span
                  >
                  Speak clearly and describe the incident
                </li>
                <li class="flex items-start">
                  <span
                    class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0"
                    >4</span
                  >
                  Press stop when finished
                </li>
                <li class="flex items-start">
                  <span
                    class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0"
                    >5</span
                  >
                  Review and upload your recording
                </li>
              </ol>
            </div>

            <!-- Tips -->
            <div class="instruction-card">
              <h3 class="font-bold text-lg mb-3 flex items-center">
                <svg
                  class="w-5 h-5 text-green-600 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Recording Tips
              </h3>
              <ul class="space-y-2 text-gray-700">
                <li class="flex items-start">
                  <span class="text-green-500 mr-2">âœ“</span>
                  <span>Find a well-lit, quiet location</span>
                </li>
                <li class="flex items-start">
                  <span class="text-green-500 mr-2">âœ“</span>
                  <span>Look directly at the camera</span>
                </li>
                <li class="flex items-start">
                  <span class="text-green-500 mr-2">âœ“</span>
                  <span>Speak slowly and clearly</span>
                </li>
                <li class="flex items-start">
                  <span class="text-green-500 mr-2">âœ“</span>
                  <span>Keep recordings under 5 minutes</span>
                </li>
                <li class="flex items-start">
                  <span class="text-green-500 mr-2">âœ“</span>
                  <span>Test audio before recording</span>
                </li>
              </ul>
            </div>

            <!-- Warnings -->
            <div class="warning-card">
              <h3 class="font-bold text-lg mb-3 flex items-center">
                <svg
                  class="w-5 h-5 text-red-600 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.346 16.5c-.77.833.192 2.5 1.732 2.5z"
                  ></path>
                </svg>
                Important Warnings
              </h3>
              <ul class="space-y-2 text-gray-700">
                <li class="flex items-start">
                  <span class="text-red-500 mr-2">â€¢</span>
                  <span>Do not share personal contact information</span>
                </li>
                <li class="flex items-start">
                  <span class="text-red-500 mr-2">â€¢</span>
                  <span>Avoid identifying other victims without consent</span>
                </li>
                <li class="flex items-start">
                  <span class="text-red-500 mr-2">â€¢</span>
                  <span>Stay in a safe location while recording</span>
                </li>
                <li class="flex items-start">
                  <span class="text-red-500 mr-2">â€¢</span>
                  <span>All videos are encrypted and secure</span>
                </li>
              </ul>
            </div>

            <!-- Upload Progress -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <h3 class="font-bold text-lg mb-4">Upload to Report</h3>
              <div id="uploadProgress" class="hidden">
                <div class="flex justify-between mb-2">
                  <span class="text-gray-700">Upload Progress</span>
                  <span id="uploadPercentage" class="font-bold">0%</span>
                </div>
                <div class="progress-bar">
                  <div id="progressFill" class="progress-fill"></div>
                </div>
                <p id="uploadStatus" class="text-sm text-gray-600 mt-2">
                  Preparing upload...
                </p>
              </div>

              <div id="uploadActions" class="space-y-4">
                <button
                  id="uploadSelected"
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200"
                  disabled
                >
                  Upload Selected Videos
                </button>
                <button
                  id="continueWithoutVideo"
                  class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-200"
                >
                  Continue Without Video
                </button>
              </div>
            </div>

            <!-- Privacy Info -->
            <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
              <h3 class="font-bold text-lg mb-2 flex items-center">
                <svg
                  class="w-5 h-5 text-blue-600 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  ></path>
                </svg>
                Privacy & Security
              </h3>
              <ul class="space-y-2 text-sm text-gray-700">
                <li class="flex items-start">
                  <span class="text-blue-500 mr-2">âœ“</span>
                  <span>End-to-end encryption</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-500 mr-2">âœ“</span>
                  <span>No facial recognition</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-500 mr-2">âœ“</span>
                  <span>Automatically deleted after 90 days</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-500 mr-2">âœ“</span>
                  <span>Accessible only to authorized personnel</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Video Player Modal -->
    <div id="videoModal" class="modal">
      <span class="modal-close">&times;</span>
      <div class="modal-content">
        <video id="modalVideo" controls class="w-full h-auto rounded-t-lg">
          Your browser does not support the video tag.
        </video>
        <div class="p-4">
          <h3 id="videoTitle" class="text-lg font-bold text-gray-800"></h3>
          <div class="flex justify-between items-center mt-4">
            <button
              id="selectVideo"
              class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg"
            >
              Select for Upload
            </button>
            <button
              id="deleteVideo"
              class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg"
            >
              Delete Video
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
      <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <div class="flex items-center space-x-2 mb-4">
              <div class="bg-blue-600 p-2 rounded-lg">
                <svg
                  class="w-6 h-6 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  ></path>
                </svg>
              </div>
              <h2 class="text-xl font-bold">ReportSafe</h2>
            </div>
            <p class="text-gray-400">
              A secure platform for reporting digital violence incidents safely
              and anonymously.
            </p>
          </div>

          <div>
            <h3 class="font-bold text-lg mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a href="/" class="text-gray-400 hover:text-white transition"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="/user/report"
                  class="text-gray-400 hover:text-white transition"
                  >File Report</a
                >
              </li>
              <li>
                <a
                  href="/user/status"
                  class="text-gray-400 hover:text-white transition"
                  >Check Status</a
                >
              </li>
              <li>
                <a href="#" class="text-gray-400 hover:text-white transition"
                  >Privacy Policy</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-gray-800 mt-8 pt-8 text-center">
          <p class="text-gray-400 mb-4">
            <strong>Important:</strong> ReportSafe is a reporting tool. If
            you're in immediate danger, contact local authorities: 911 (US) or
            your local emergency number.
          </p>
          <p class="text-gray-500 text-sm">
            Â© 2024 ReportSafe. All rights reserved. This is a demonstration
            system.
          </p>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Mobile Menu Toggle
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");

        mobileMenuButton.addEventListener("click", function () {
          mobileMenu.classList.toggle("hidden");
        });

        // Close mobile menu when clicking a link
        document.querySelectorAll("#mobile-menu a").forEach((link) => {
          link.addEventListener("click", () => {
            mobileMenu.classList.add("hidden");
          });
        });

        // Video Recording Variables
        let mediaRecorder;
        let recordedChunks = [];
        let recordingTimer;
        let recordingSeconds = 0;
        let selectedVideos = new Set();
        let currentStream = null;

        // DOM Elements
        const previewVideo = document.getElementById("previewVideo");
        const placeholderVideo = document.getElementById("placeholderVideo");
        const permissionOverlay = document.getElementById("permissionOverlay");
        const recordingIndicator =
          document.getElementById("recordingIndicator");
        const timerElement = document.getElementById("timer");
        const startRecordingBtn = document.getElementById("startRecording");
        const stopRecordingBtn = document.getElementById("stopRecording");
        const pauseRecordingBtn = document.getElementById("pauseRecording");
        const requestPermissionBtn =
          document.getElementById("requestPermission");
        const recordedVideosContainer =
          document.getElementById("recordedVideos");
        const noVideosMessage = document.getElementById("noVideosMessage");
        const uploadSelectedBtn = document.getElementById("uploadSelected");
        const continueWithoutVideoBtn = document.getElementById(
          "continueWithoutVideo"
        );
        const uploadProgress = document.getElementById("uploadProgress");
        const uploadPercentage = document.getElementById("uploadPercentage");
        const progressFill = document.getElementById("progressFill");
        const uploadStatus = document.getElementById("uploadStatus");

        // Request camera permission
        requestPermissionBtn.addEventListener("click", async function () {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user",
              },
              audio: true,
            });

            currentStream = stream;
            previewVideo.srcObject = stream;
            placeholderVideo.classList.add("hidden");
            permissionOverlay.classList.add("hidden");
            startRecordingBtn.disabled = false;

            // Populate camera devices
            await populateCameraDevices();
          } catch (error) {
            console.error("Error accessing camera:", error);
            permissionOverlay.innerHTML = `
                        <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-xl font-bold mb-2">Camera Access Denied</h3>
                        <p class="text-gray-300 mb-4">Please enable camera access in your browser settings to record video evidence.</p>
                        <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                            Try Again
                        </button>
                    `;
          }
        });

        // Populate available cameras
        async function populateCameraDevices() {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(
              (device) => device.kind === "videoinput"
            );
            const cameraSelect = document.getElementById("cameraSelect");

            cameraSelect.innerHTML =
              '<option value="">Select Camera...</option>';

            videoDevices.forEach((device, index) => {
              const option = document.createElement("option");
              option.value = device.deviceId;
              option.text = device.label || `Camera ${index + 1}`;
              cameraSelect.appendChild(option);
            });

            // Add camera change listener
            cameraSelect.addEventListener("change", async function () {
              if (currentStream) {
                currentStream.getTracks().forEach((track) => track.stop());
              }

              const constraints = {
                video: {
                  deviceId: this.value ? { exact: this.value } : undefined,
                  width: { ideal: 1280 },
                  height: { ideal: 720 },
                },
                audio: true,
              };

              try {
                const stream = await navigator.mediaDevices.getUserMedia(
                  constraints
                );
                currentStream = stream;
                previewVideo.srcObject = stream;
              } catch (error) {
                console.error("Error switching camera:", error);
              }
            });
          } catch (error) {
            console.error("Error enumerating devices:", error);
          }
        }

        // Start recording
        startRecordingBtn.addEventListener("click", function () {
          if (!currentStream) return;

          recordedChunks = [];

          // Configure MediaRecorder
          const options = {
            mimeType: "video/webm;codecs=vp9,opus",
            videoBitsPerSecond: 2500000, // 2.5 Mbps
          };

          try {
            mediaRecorder = new MediaRecorder(currentStream, options);
          } catch (error) {
            console.error("MediaRecorder error:", error);
            // Try different MIME types
            const mimeTypes = [
              "video/webm;codecs=vp8,opus",
              "video/webm",
              "video/mp4",
              "",
            ];

            for (const mimeType of mimeTypes) {
              try {
                mediaRecorder = new MediaRecorder(currentStream, { mimeType });
                break;
              } catch (e) {
                continue;
              }
            }

            if (!mediaRecorder) {
              alert("Your browser does not support video recording.");
              return;
            }
          }

          // MediaRecorder event handlers
          mediaRecorder.ondataavailable = function (event) {
            if (event.data.size > 0) {
              recordedChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = function () {
            const blob = new Blob(recordedChunks, {
              type: mediaRecorder.mimeType,
            });
            const url = URL.createObjectURL(blob);

            // Add recorded video to list
            addRecordedVideo(url, recordingSeconds);

            // Reset recording state
            recordingSeconds = 0;
            clearInterval(recordingTimer);
            timerElement.textContent = "00:00";
            recordingIndicator.classList.add("hidden");
            startRecordingBtn.classList.remove("hidden");
            stopRecordingBtn.classList.add("hidden");
            pauseRecordingBtn.classList.add("hidden");
            stopRecordingBtn.disabled = true;
          };

          mediaRecorder.onerror = function (event) {
            console.error("MediaRecorder error:", event.error);
            alert("Error during recording: " + event.error);
          };

          // Start recording
          mediaRecorder.start(1000); // Collect data every second

          // Update UI
          startRecordingBtn.classList.add("hidden");
          stopRecordingBtn.classList.remove("hidden");
          stopRecordingBtn.disabled = false;
          pauseRecordingBtn.classList.remove("hidden");
          recordingIndicator.classList.remove("hidden");

          // Start timer
          recordingTimer = setInterval(function () {
            recordingSeconds++;
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            timerElement.textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            // Auto-stop after 5 minutes (300 seconds)
            if (recordingSeconds >= 300) {
              stopRecording();
            }
          }, 1000);
        });

        // Stop recording
        stopRecordingBtn.addEventListener("click", stopRecording);

        function stopRecording() {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
        }

        // Pause/resume recording
        let isPaused = false;
        pauseRecordingBtn.addEventListener("click", function () {
          if (!mediaRecorder) return;

          if (mediaRecorder.state === "recording") {
            mediaRecorder.pause();
            isPaused = true;
            pauseRecordingBtn.innerHTML = `
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
            pauseRecordingBtn.title = "Resume Recording";
          } else if (mediaRecorder.state === "paused") {
            mediaRecorder.resume();
            isPaused = false;
            pauseRecordingBtn.innerHTML = `
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
            pauseRecordingBtn.title = "Pause Recording";
          }
        });

        // Add recorded video to list
        function addRecordedVideo(url, duration) {
          noVideosMessage.style.display = "none";

          const videoId = "video_" + Date.now();
          const videoItem = document.createElement("div");
          videoItem.className = "video-thumbnail";
          videoItem.dataset.videoId = videoId;
          videoItem.dataset.url = url;

          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          const durationText = `${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;

          videoItem.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="relative flex-shrink-0">
                            <div class="w-32 h-24 bg-gray-800 rounded-lg flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="play-button">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-medium">Video Statement</h4>
                            <p class="text-sm text-gray-600">Duration: ${durationText}</p>
                            <p class="text-sm text-gray-600">Recorded: Just now</p>
                        </div>
                        <div>
                            <input type="checkbox" class="video-checkbox h-5 w-5 text-blue-600 rounded" data-video-id="${videoId}">
                        </div>
                    </div>
                `;

          recordedVideosContainer.prepend(videoItem);
          updateUploadButton();

          // Add click handler for playback
          videoItem
            .querySelector(".play-button")
            .addEventListener("click", function () {
              openVideoModal(url, videoId);
            });

          // Add checkbox handler
          const checkbox = videoItem.querySelector(".video-checkbox");
          checkbox.addEventListener("change", function () {
            if (this.checked) {
              selectedVideos.add(videoId);
            } else {
              selectedVideos.delete(videoId);
            }
            updateUploadButton();
          });
        }

        // Open video modal
        function openVideoModal(url, videoId) {
          const modal = document.getElementById("videoModal");
          const modalVideo = document.getElementById("modalVideo");
          const videoTitle = document.getElementById("videoTitle");
          const selectVideoBtn = document.getElementById("selectVideo");
          const deleteVideoBtn = document.getElementById("deleteVideo");
          const modalClose = document.querySelector("#videoModal .modal-close");

          modalVideo.src = url;
          videoTitle.textContent = "Video Statement";

          // Update select button state
          selectVideoBtn.dataset.videoId = videoId;
          selectVideoBtn.innerHTML = selectedVideos.has(videoId)
            ? "âœ“ Selected"
            : "Select for Upload";

          selectVideoBtn.onclick = function () {
            const checkbox = document.querySelector(
              `.video-checkbox[data-video-id="${videoId}"]`
            );
            if (checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event("change"));
              selectVideoBtn.innerHTML = checkbox.checked
                ? "âœ“ Selected"
                : "Select for Upload";
            }
          };

          deleteVideoBtn.onclick = function () {
            if (confirm("Are you sure you want to delete this video?")) {
              const videoItem = document.querySelector(
                `[data-video-id="${videoId}"]`
              );
              if (videoItem) {
                videoItem.remove();
                selectedVideos.delete(videoId);
                updateUploadButton();

                // Show "no videos" message if empty
                if (recordedVideosContainer.children.length === 1) {
                  // 1 for the message
                  noVideosMessage.style.display = "block";
                }
              }
              modal.style.display = "none";
              URL.revokeObjectURL(url);
            }
          };

          modalClose.onclick = function () {
            modal.style.display = "none";
            modalVideo.pause();
          };

          modal.style.display = "block";
        }

        // Update upload button state
        function updateUploadButton() {
          if (selectedVideos.size > 0) {
            uploadSelectedBtn.disabled = false;
            uploadSelectedBtn.textContent = `Upload ${
              selectedVideos.size
            } Video${selectedVideos.size > 1 ? "s" : ""}`;
          } else {
            uploadSelectedBtn.disabled = true;
            uploadSelectedBtn.textContent = "Upload Selected Videos";
          }
        }

        // Upload selected videos
        uploadSelectedBtn.addEventListener("click", async function () {
          if (selectedVideos.size === 0) return;

          // Show upload progress
          uploadProgress.classList.remove("hidden");
          uploadSelectedBtn.disabled = true;
          continueWithoutVideoBtn.disabled = true;

          // Simulate upload progress
          let progress = 0;
          const interval = setInterval(() => {
            progress += 10;
            uploadPercentage.textContent = progress + "%";
            progressFill.style.width = progress + "%";

            if (progress <= 30) {
              uploadStatus.textContent = "Preparing files...";
            } else if (progress <= 60) {
              uploadStatus.textContent = "Encrypting video data...";
            } else if (progress <= 90) {
              uploadStatus.textContent = "Uploading to secure server...";
            } else {
              uploadStatus.textContent = "Finalizing upload...";
            }

            if (progress >= 100) {
              clearInterval(interval);
              setTimeout(() => {
                uploadStatus.textContent = "âœ… Upload complete!";

                // Redirect to report page with success message
                setTimeout(() => {
                  window.location.href = "/user/report?videoUpload=success";
                }, 1500);
              }, 500);
            }
          }, 200);
        });

        // Continue without video
        continueWithoutVideoBtn.addEventListener("click", function () {
          if (
            confirm(
              "Are you sure you want to continue without uploading video evidence?"
            )
          ) {
            window.location.href = "/user/report";
          }
        });

        // Camera orientation
        document
          .getElementById("portraitMode")
          .addEventListener("click", function () {
            this.classList.add("bg-blue-600", "text-white");
            this.classList.remove("bg-gray-200", "text-gray-800");
            document
              .getElementById("landscapeMode")
              .classList.remove("bg-blue-600", "text-white");
            document
              .getElementById("landscapeMode")
              .classList.add("bg-gray-200", "text-gray-800");

            // In a real app, you would adjust camera constraints here
          });

        document
          .getElementById("landscapeMode")
          .addEventListener("click", function () {
            this.classList.add("bg-blue-600", "text-white");
            this.classList.remove("bg-gray-200", "text-gray-800");
            document
              .getElementById("portraitMode")
              .classList.remove("bg-blue-600", "text-white");
            document
              .getElementById("portraitMode")
              .classList.add("bg-gray-200", "text-gray-800");

            // In a real app, you would adjust camera constraints here
          });

        // Video quality selection
        document
          .getElementById("qualitySelect")
          .addEventListener("change", function () {
            // In a real app, you would adjust camera constraints based on quality selection
            console.log("Selected quality:", this.value);
          });

        // Close modals on outside click
        window.addEventListener("click", function (event) {
          const videoModal = document.getElementById("videoModal");
          if (event.target === videoModal) {
            videoModal.style.display = "none";
            document.getElementById("modalVideo").pause();
          }
        });

        // Clean up on page unload
        window.addEventListener("beforeunload", function () {
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          // Revoke all object URLs
          document.querySelectorAll(".video-thumbnail").forEach((thumbnail) => {
            const url = thumbnail.dataset.url;
            if (url) {
              URL.revokeObjectURL(url);
            }
          });
        });
      });
    </script>
  </body>
</html>
